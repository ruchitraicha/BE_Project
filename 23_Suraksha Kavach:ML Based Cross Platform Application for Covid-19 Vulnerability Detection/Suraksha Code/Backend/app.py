from flask import Flask, session, redirect, url_for, jsonify
from flask import render_template,request
import pymysql

import json
import pandas as pd
import pickle

app = Flask(__name__)

app.secret_key = 'any random string'


def dbConnection():
    try:
        connection = pymysql.connect(host="localhost", user="root", password="root", database="suraksh_kavach")
        return connection
    except:
        print("Something went wrong in database Connection")

def dbClose():
    try:
        dbConnection().close()
    except:
        print("Something went wrong in Close DB Connection")

con = dbConnection()
cursor = con.cursor()

@app.route('/register', methods=['GET', 'POST'])
def register():
    if request.method == 'POST':
        
        #getting the response data
        request_data = request.data 
        #converting it from json to key value pair
        request_data = json.loads(request_data.decode('utf-8'))
        
        
        username = request_data['username']
        email = request_data['email']
        mobile = request_data['mobile']
        password = request_data['password']
        
        sql1 = "INSERT INTO usertable(username, email, mobile, password) VALUES (%s, %s, %s, %s);"
        val1 = (username, email, mobile, password)
        cursor.execute(sql1,val1)
        con.commit()
        
        return "success"

@app.route('/login', methods=['GET', 'POST'])
def login():
    if request.method == "POST":
        
        #getting the response data
        request_data = request.data 
        #converting it from json to key value pair
        request_data = json.loads(request_data.decode('utf-8'))
        
        username = request_data['name']
        password = request_data['pass']
        
        cursor.execute('SELECT * FROM usertable WHERE username = %s AND password = %s', (username, password))
        count = cursor.rowcount
        if count == 1:            
            return "success"
        else:
            return "fail"
        
@app.route('/prediction', methods=['GET', 'POST'])
def prediction():
    if request.method == "POST":
        
        #getting the response data
        request_data = request.data 
        #converting it from json to key value pair
        request_data = json.loads(request_data.decode('utf-8'))
        
        age = request_data['age']
        state = request_data['state']
        
        Age_Bracket = int(age)
        State_UnionTerritory_cat = state
        
        data= pd.read_csv("processed.csv")
        state_code = data.loc[data['State/UnionTerritory'] == State_UnionTerritory_cat, 'State/UnionTerritory_cat'].iloc[0]
        
        dfd = {"Age_Bracket" : Age_Bracket,"state_code" : state_code}
        
        new = pd.DataFrame(dfd, index=[0])
        print(new)
        
        with open('rf_pickle1', 'rb') as f:
            rfpic = pickle.load(f)
        
        rfpic=rfpic.predict(new)
        strpre = str(int(rfpic))
        print("rfpic")
        print(strpre)
        
        return strpre

if __name__ == "__main__":
    app.run("0.0.0.0")